Задача подбора коэффициентов для термокомпенсированного кварцевого генератора.

             Устройстово термокомпенсированного кварцевого генератора.

Термокомпенсированный кварцевый генератор - это микросборка, состоящая из кварцевого
резонатора и микросхемы-генератора. Собственная частота резонатора достаточно
стабильна, но зависит от температуры. Зависимость от температуры различается для
разных экземпляров генератора. Для  большинства экземпляров относительный размах
этой зависимости составляет +- 3e-5 от среднего значения частоты, а среднее значение
частоты может отличаться от требуемой частоты f0 на величину такого же порядка.

Микроскема возбуждает колебания и влияет на их частоту с помощью варикапа - ёмкости,
управляемой напражением. Цель этого варикапа - компенсировать температурную
зависимость так, чтобы уменьшить относительный размах. То есть частота, выдаваемая
сборкой есть f(t, u), где t - температура резонатора, u - цифровое значение на
входе ЦАП, выдающего напряжение на варикап, который корректирует частоту колебаний.
u - 12-разрядное целое число от 0 до 4095.

Микросхема содержить внутри себя:
- датчик температуры микросхемы;
- АЦП, преводящее аналоговое показание датчика в 12-разрядный цифровой код T,
  диапазон которого исользуется не полностью, а где-то от 1000 до 3000;
- цифровой вычилитель u=u(T,K), где К-вектор коэффициентов;
- программируемая память коэффициентов K.

Вектор коэффициентов K состоит из компонент
K=(INFBIT, SBIT, K1BIT, K2BIT, K3BIT, K4BIT, K5BIT).
Коэффициенты - целые числа в диапазонах
INFBIT [0,63]    6 бит
SBIT   [0,31]    5 бит
K1BIT  [1,255]   8 бит
K2BIT  [0,127]   7 бит
K3BIT  [0,31]    5 бит
K4BIT  [0,31]    5 бит
K5BIT  [0,15]    4 бит .
Таким образом, K может быть представлен 40-битным двоичным числом.

Цифровой вычислитель был задуман вычислять следующий CodeList:
МОДЕЛЬ СПЕЦИФИКАЦИИ
xd = T - (1535 + 8*INFBIT);
xs = floor( xd * (16 + SBIT) / 32 + 0.5);
pr2 = (K4BIT - 25) * 512 + K5BIT * xs;
res3 = (K3BIT * 512 + 4096) + floor( pr2 * xs / 1024 + 0.5 );
res4 = (K2BIT * 128 + 2560) + floor( res3 * xs / 1024 + 0.5 );
res5 = (- K1BIT * 128 -  195*64 + floor( (res4 * xs - 1) / 1024 + 0.5 );
res6 = 1032 + floor( res5 * xs / 16384 + 0.5);
u = max(0, min(4095, res6)).

Фактически умножитель был реализован с ошибкой, добавляющей к произведениям
K5BIT*xs, pr2*xs, res3*xs,res4*xs,res5*xs дополнительный перенос 0,1 или 2, сложно
зависящий от предыдущих вычислений. Эту ошибку нашли после изготовления партии
микросхем, но исправленные микросхемы перевыпускать не стали.

Мы можем описать поведение изготовленного вычислителя таким образом:
МОДЕЛЬ АППАРАТУРЫ

xd = T - (1535 + 8*INFBIT);
xs = floor( xd * (16 + SBIT) / 32 + 0.5);
pr2 = (K4BIT - 25) * 512 + K5BIT * xs + p1;
res3 = (K3BIT * 512 + 4096) + floor( (pr2 * xs + p2) / 1024 + 0.5 );
res4 = (K2BIT * 128 + 2560) + floor( (res3 * xs + p3) / 1024 + 0.5 );
res5 = (- K1BIT * 128 -  195*64 + floor( (res4 * xs + p4 - 1) / 1024 + 0.5 );
res6 = 1032 + floor( (res5 * xs + p5) / 16384 + 0.5);
u = max(0, min(4095, res6)),

где p1, p2, p3, p4, p5 - сложные целочисленные функции коэффициентов и температуры,
содержащиеся в интервалах
p1 in [0,1]
p2 in [0,2]
p3 in [0,2]
p4 in [0,2]
p5 in [0,2] .

Если приближённо заменить floor(z + 0.5) на z, ввести обозначения
МОДЕЛЬ ИДЕАЛИЗИРОВАННАЯ
INF = 1535 + 8*INFBIT
SCALE = (SBIT + 16)/32
K0 = 1032
K1 = -195 - 2*K1BIT
K2 = (20 + K2BIT)/2
K3 = (8 + K3BIT)/2
K4 = (K4BIT - 25)/8
K5 = K5BIT/16
и масштабировать переменную (см. ниже), а также масштабировать
 pr2 * 2^-12
 res3 * 2^-10
 res4 * 2^-8
 res5 * 2^-6
 res6 * 2^0,
тогда функция вычислителя приближённо записывается
 xs = (T - INF) * SCALE;
 x = xs * 2^-8;
 u = max(0, min(4095, K0 + K1 * x + K2 * x^2 + K3 * x^3 + K4 * x^4 + K5 * x^5));

Диапазоны и шаг переобозначенных коэффициетов
INF   [1535,2039]   8
SCALE [0.5,1.46875] 1/32
K0    [1032,1032]
K1    [-705,-195]   2
K2    [10,73.5]     1/2
K3    [4,19.5]      1/2
K4    [-3.125,0.75] 1/8
K5    [0,0.9375]    1/16

                      Обмер экземпляра генератора

Описанная выше цифровая часть одинакова для всех экземпляров генератора,
Тем не менее конкретные экземпляры могут отличаться в следующем:
- различия собственной частоты резонатора и её температурной зависимости;
- различия переходной характеристики термодатчика;
- различия вольт-фарадной характеристики варикапа;
- раличия собственной ёмкости резонатора, то есть чувствительность частоты
  к ёмкости варикапа;
- различия тепловых характеристик микросборки, приводящих к неодинаковой температуре
  резонатора и термодатчика.

Поэтому проводят обмер каждого экземпляра генератора. Партию генераторов помещают
в термокамеру и меняют их температуру. Во время измерений читают цифровые показания
термодатчика T и подбирают числовое значение u на входе ЦАП  при котором генератор
выдаёт требуемую частоту f0. Кроме того, меряют изменение частоты при небольшом изменении u
для оценки чувствительности частоты к u.

Термодатчик находится в микроскеме. Температура микросхемы может отличаться от температуры
резонатора:
- из-за нагрева микросхемы;
- при меняющейся внешней температуре - из-за разных тепловых сопротивлений от внешней среды
  до резонатора и до термодатчика в микросхеме.

Техническое задание на генератор предполагает ограниченную скорость изменения внешней
температуры. Тем не менее, если мы обмеряем микросхему при изменении температуры от холодного
к горячему и от горячего к холодному, то получаем своего рода гистерезис - разные значения u,
при котором генератор выдаёт требуемую частоту f0 на прямом и обратном проходе. Этот гистерезис
имеет место даже и при очень медленной скорости изменения температуры. Видимо есть ещё какая-то
физическая причина этого, но её пока не выяснили.

В процессе измерения мы можем отключить цифровой вычислитель и вместо этого устанавливать u через
отладочный интерфейс микросхемы. Тем самым мы можем подобрать цифровое значение u, заставляющее
генератор выдавать требуемую частоту f0.

Поэтому мы намерили:
u_inf_i и u_sup_i - цифровые значения u, выдающие требуемую частоту f0 при показании термодатчика
                    T_i при прямом и обратном измерении;
df_du_i - оценка чувствительности частоты к значению u при показаниях термодатчика T_i.

                 Задача подбора коэффициентов.

Техническое задание задаёт относительную стабильность частоты. Они называют её ppm. То есть
частота f должна назходиться в пределах
f0*(1-ppm) <= f <= f0*(1+ppm) (1)
во всём температурном диапазоне при ограниченной
скорости изменения температуры. Обычно ppm = 1e-6 .

Это соотвтетствует тому, что вектор коэффициентов K должен быть таким, что при каждой температуре T_i 
  
u_sup_i - f0*ppm/df_du_i <= u(T_i,K) <= u_inf_i + f0*ppm/df_du_i (2)

Другими словами, чем больше гистерезис u_sip_i-u_inf_i, тем меньше может значение вычислителя u(T_i,K)
вылазить за пределы [u_inf_i,u_sup_i]. Если гистерезис слишком большой u_sup_i-u_inf_i > f0*2*ppm/df_du_i
для хотя бы одной T_i, то такой генератор компенсировать до стабильности ppm невозможно.

Казалось бы эта задача, в постановке которой есть интервальность по u. Однако, если говорить честно,
её можно сформулировать и неинтервальным способом. Рассмотрим оптимизационную задачу с переменными K
и ppm . Её ограничениями являются неравенства (2), а её целевая функция ppm -> min .

